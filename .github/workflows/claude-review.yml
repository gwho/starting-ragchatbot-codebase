name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Analyze code changes
        id: analyze
        run: |
          echo "## ðŸ¤– Claude Code Review" > review.md
          echo "" >> review.md

          # Count changes
          CHANGED_FILES=$(wc -l < changed_files.txt)
          echo "### Summary" >> review.md
          echo "- **Files changed**: $CHANGED_FILES" >> review.md
          echo "" >> review.md

          # Analyze Python files
          PYTHON_FILES=$(grep '\.py$' changed_files.txt || true)
          if [ -n "$PYTHON_FILES" ]; then
            echo "### Python Files Analysis" >> review.md
            echo "" >> review.md

            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "#### \`$file\`" >> review.md
                LINES=$(wc -l < "$file")
                echo "- Lines of code: $LINES" >> review.md
                echo "" >> review.md
              fi
            done <<< "$PYTHON_FILES"
          fi

          # Check for common issues
          echo "### Code Quality Checks" >> review.md
          echo "" >> review.md

          # Run quick linting checks
          if echo "$PYTHON_FILES" | xargs -I {} test -f {} && uv run flake8 $PYTHON_FILES --count --exit-zero --max-line-length=100 > flake8_output.txt 2>&1; then
            ISSUES=$(cat flake8_output.txt | tail -n 1)
            if [ "$ISSUES" != "0" ]; then
              echo "âš ï¸ **Flake8 found $ISSUES issues**" >> review.md
              echo '```' >> review.md
              cat flake8_output.txt >> review.md
              echo '```' >> review.md
            else
              echo "âœ… No linting issues found" >> review.md
            fi
          fi
          echo "" >> review.md

          # Check test coverage
          if [ -d "backend/tests" ]; then
            echo "### Test Coverage Reminder" >> review.md
            echo "" >> review.md
            echo "ðŸ“ Please ensure you've added tests for new functionality:" >> review.md
            echo "- Unit tests in \`backend/tests/\`" >> review.md
            echo "- Run tests with: \`uv run pytest backend/tests/\`" >> review.md
            echo "" >> review.md
          fi

          # Add suggestions
          echo "### Recommendations" >> review.md
          echo "" >> review.md
          echo "- âœ… Run \`./scripts/check.sh\` before committing" >> review.md
          echo "- âœ… Ensure all tests pass locally" >> review.md
          echo "- âœ… Update documentation if needed" >> review.md
          echo "" >> review.md
          echo "---" >> review.md
          echo "*This review was automatically generated by Claude Code*" >> review.md

      - name: Post review comment
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file review.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add review reaction
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            -f event='COMMENT' \
            -f body='ðŸ¤– Automated code review completed. Check the comments above for details.'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
